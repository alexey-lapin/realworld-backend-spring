import http from "k6/http";
import { check, sleep } from "k6";

export const options = {
  vus: 5,
  duration: "30s",
  thresholds: {
    http_req_failed: ["rate<0.01"],
    http_req_duration: ["p(95)<750"],
  },
};

const BASE_URL = __ENV.BASE_URL || "http://localhost:8080/api";

function randomSuffix() {
  return `${Date.now()}-${Math.floor(Math.random() * 1e9)}`;
}

function buildTagBag(size) {
  const runId = randomSuffix();
  return Array.from({ length: size }, (_, index) => `k6-tag-${runId}-${index}`);
}

function pickTags(tagBag) {
  const count = Math.floor(Math.random() * 6);

  if (count === 0) {
    return [];
  }

  const picked = new Set();
  while (picked.size < count) {
    const index = Math.floor(Math.random() * tagBag.length);
    picked.add(tagBag[index]);
  }

  return Array.from(picked);
}

function registerUser() {
  const suffix = randomSuffix();
  const payload = {
    user: {
      email: `k6-${suffix}@example.com`,
      username: `k6_${suffix}`,
      password: "Passw0rd!",
    },
  };

  const res = http.post(`${BASE_URL}/users`, JSON.stringify(payload), {
    headers: { "Content-Type": "application/json" },
  });

  check(res, {
    "register user status is 201": (r) => r.status === 201,
  });

  const body = res.json();
  if (!body || !body.user || !body.user.token) {
    throw new Error(`Missing auth token in response: ${res.body}`);
  }

  return body.user.token;
}

function buildArticlePayload(tagList) {
  const suffix = `${__VU}-${__ITER}-${Math.random().toString(16).slice(2)}`;
  return {
    article: {
      title: `Load test ${suffix}`,
      description: "Load test article",
      body: `Generated by k6 (${suffix}).`,
      tagList,
    },
  };
}

export function setup() {
  return {
    token: registerUser(),
    tagBag: buildTagBag(200),
  };
}

export default function (data) {
  const tagList = pickTags(data.tagBag);
  const payload = buildArticlePayload(tagList);
  const res = http.post(`${BASE_URL}/articles`, JSON.stringify(payload), {
    headers: {
      "Content-Type": "application/json",
      Authorization: `Token ${data.token}`,
    },
  });

  check(res, {
    "create article status is 201": (r) => r.status === 201,
  });

  sleep(1);
}
